<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<script src="../wlyy-yc/src/main/resources/app/js/mui.min.js"></script>
		<script src="../wlyy-yc/src/main/resources/app/html/yichangguanli/js/common.js"></script>
		<link href="../wlyy-yc/src/main/resources/app/css/mui.min.css" rel="stylesheet" />
		<script type="text/javascript" charset="utf-8">
			mui.init();
		</script>
	</head>

	<body>
		<script src="../wlyy-yc/src/main/resources/app/js/common_http.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			var wgtVer = null;
			mui.plusReady(function() {
				judgePage();
				return;
				// 获取本地应用资源版本号
			    plus.runtime.getProperty(plus.runtime.appid, function(inf){
			        wgtVer = inf.version;
			        console.log("当前应用版本：" + wgtVer);
			        
					if(plus.os.name == "iOS") {
						// 检测app小版本的更新
						checkUpgrade();
					} else if(plus.os.name == "Android") {
						// 先检测大版本的更新，如果没有再检测app小版本的更新
						checkVersion();
					}
			   });
			});
			/*
			 * 在安卓条件下检查版本
			 */
			function checkVersion() {
				plus.nativeUI.showWaiting();

				mui.ajax(server + 'version/app', {
					data: {
						version: curr_app_version,
						code: "app_doc"
					},
					dataType: 'json', //服务器返回json格式数据
					type: 'post', //HTTP请求类型
					timeout: 10000, //超时时间设置为10秒；
					success: function(res) {
						console.log(JSON.stringify(res));
						plus.nativeUI.closeWaiting();
						if(res.status == 200) {
							if(res.url) {
								mui.confirm("发现新版本，下载更新？", "更新", ["立即更新", "取　　消"], function(event) {
									if(0 == event.index) {
										plus.runtime.openURL(res.url);
									}
								});
								
								judgePage();
							}
							else {
								// 没有大版本时就检测小版本的升级
								checkUpgrade();
							}
						} else {
							judgePage();
						}
					},
					error: function(xhr, type, errorThrown) {
						if(type == "timeout" || type == "abort" || type == "error") {
							//mui.confirm("网络异常，请稍后重试！", "", ["退出"], function() {
							//	plus.runtime.quit();
							//});
							plus.nativeUI.toast("网络错误: 无法进行版本升级检测！");
							plus.nativeUI.closeWaiting();
						}
						judgePage();
					}
				});
			}

			// 检测app小版本的更新
			function checkUpgrade(){
				mui.ajax(server + 'version/app', {
					data: {
						version: 0,//资源包不以version_int号来校验升级信息，而以version_str判断.version_str不相同就会升级。
						code: "wgt"
					},
					dataType: 'json', //服务器返回json格式数据
					type: 'post', //HTTP请求类型
					timeout: 10000, //超时时间设置为10秒；
					success: function(res) {
						console.log(JSON.stringify(res));
						if(res.status == 200) {
							if(res.data && res.data.version_str && wgtVer && (res.data.version_str != wgtVer)) {
			    				console.log("下载升级包...");
					            downWgt(res.data.url);  // 下载升级包
							} else {
								judgePage();
							}
						} else {
							judgePage();
						}
					},
					error: function(xhr, type, errorThrown) {
						if(type == "timeout" || type == "abort" || type == "error") {
							plus.nativeUI.toast("网络错误: 无法进行版本升级检测！");
						}
						judgePage();
					}
				});
			}
			
			// 下载wgt文件
			function downWgt(wgtUrl){
			    plus.nativeUI.showWaiting("检测到有更新版本，正在下载文件...");
			    plus.downloader.createDownload( wgtUrl, {filename:"_doc/update/"}, function(d,status){
			        plus.nativeUI.closeWaiting();
			        if ( status == 200 ) {
			            console.log("下载升级文件成功：" + d.filename);
			            installWgt(d.filename); // 安装wgt包
			        } else {
			            console.log("下载升级文件失败！");
			            plus.nativeUI.alert("下载升级文件失败！");
			            
			            judgePage();
			        }
			    }).start();
			}
			
			// 更新应用资源
			function installWgt(path){
			    plus.nativeUI.showWaiting("正在安装资源升级包...");
			    plus.runtime.install(path,{},function(){
			        plus.nativeUI.closeWaiting();
			        console.log("安装升级成功！");
			        plus.nativeUI.alert("升级完成，请点击确定对App进行重启！",function(){
			            plus.runtime.restart();
			        });
			    },function(e){
			        plus.nativeUI.closeWaiting();
			        plus.nativeUI.toast("安装升级失败！错误信息[" + e.code + "]：" + e.message);
			        console.log("安装升级失败["+e.code+"]："+e.message);
			        judgePage();
			    });
			}

			//判断是否已登陆过
			function judgePage() {
				var Request = GetRequest();
				var userId = Request["userId"]; // userId
				var uId = Request["userId"];     //userCode
				var ticket = Request["ticket"];
				var iMei = plus.device.uuid;
				var platform = 2;
				var oUserAgent = {
					"id": userId,
					"uid": uId,
					"imei": iMei,
					"token": ticket,
					"platform": platform,
				};
				userAgent = JSON.stringify(oUserAgent);
				//plus.navigator.setUserAgent(userAgent);
				plus.storage.setItem("userAgent", userAgent);

				var orgId = Request["orgId"];
				var	vaildTime = Request["vaildTime"];
				var	appUID = Request["appUID"];
				var	appType = Request["appType"];

				plus.storage.setItem("orgId", orgId);
				plus.storage.setItem("appUID", appUID);
				plus.storage.setItem("ticket", ticket);
				plus.storage.setItem("userId", userId);

				mui.openWindow('html/yichangguanli/html/main.html', 'main', {});
			}
		</script>
	</body>

</html>